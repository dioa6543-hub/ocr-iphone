<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>OCR iPhone + fond + sauvegarde</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    body{font-family:system-ui;margin:0;padding:1rem;background:#fafafa}
    button{width:100%;padding:1rem;font-size:1.3rem;margin:.5rem 0}
    textarea{width:100%;height:150px;font-size:1.1rem}
    #video{width:100%;border:1px solid #ccc}
    /* fond dÃ©coratif (barre de recherche) si on dÃ©tecte image.png/jpg */
    .search-bar-bg{
      height:60px;
      background:url("image.png") center/cover no-repeat;
      border-radius:8px;
      margin-bottom:1rem;
    }
  </style>
</head>
<body>

  <!-- fond conditionnel -->
  <div id="topBg"></div>

  <h1>ğŸ“· OCR iPhone</h1>
  <button id="openCam">Autoriser camÃ©ra</button>
  <video id="video" playsinline autoplay></video>
  <button id="snapBtn" disabled>ğŸ“¸ Prendre photo</button>
  <button id="scanBtn" disabled>ğŸ” Lancer OCR</button>

  <h3>Texte :</h3>
  <textarea id="out" placeholder="Texte apparaÃ®tra iciâ€¦"></textarea>

  <button id="saveBtn">ğŸ’¾ Enregistrer le texte</button>
  <button id="readBtn">ğŸ”Š Lire</button>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    const video=document.getElementById('video');
    const openCam=document.getElementById('openCam');
    const snapBtn=document.getElementById('snapBtn');
    const scanBtn=document.getElementById('scanBtn');
    const out=document.getElementById('out');
    const saveBtn=document.getElementById('saveBtn');
    const readBtn=document.getElementById('readBtn');
    const topBg=document.getElementById('topBg');

    let stream, imgBlob;

    /* 1. fond dÃ©coratif si image.png ou image.jpg existe */
    fetch('image.png').then(r=>{
      if(r.ok) topBg.innerHTML='<div class="search-bar-bg"></div>';
    }).catch(()=>
      fetch('image.jpg').then(r=>{
        if(r.ok) topBg.innerHTML='<div class="search-bar-bg" style="background:url(\'image.jpg\') center/cover no-repeat;"></div>';
      })
    );

    /* 2. CamÃ©ra */
    openCam.onclick=async()=>{
      try{
        stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
        video.srcObject=stream;
        snapBtn.disabled=false;
      }catch(e){alert('CamÃ©ra refusÃ©e â€“ utilise HTTPS et Safari');}
    };

    /* 3. Snapshot */
    snapBtn.onclick=()=>{
      const canvas=document.createElement('canvas');
      canvas.width=video.videoWidth; canvas.height=video.videoHeight;
      canvas.getContext('2d').drawImage(video,0,0);
      canvas.toBlob(blob=>{imgBlob=blob; scanBtn.disabled=false;},'image/png');
    };

    /* 4. OCR */
    scanBtn.onclick=async()=>{
      out.value='â³ OCRâ€¦';
      const worker=await Tesseract.createWorker('fra');
      try{
        const ret=await worker.recognize(imgBlob);
        out.value=ret.data.text;
      }catch(err){out.value='Erreur : '+err.message;}
      finally{worker.terminate();}
    };

    /* 5. Sauvegarde */
    saveBtn.onclick=()=>{
      const blob=new Blob([out.value],{type:'text/plain'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download='texte_ocr.txt';
      a.click();
      URL.revokeObjectURL(url);
    };

    /* 6. Lecture vocale */
    readBtn.onclick=()=>{
      const u=new SpeechSynthesisUtterance(out.value);
      u.lang='fr-FR';
      speechSynthesis.speak(u);
    };
  </script>

</body>
</html>
